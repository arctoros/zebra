                        ; --------------------------------------
                        ; zasm: assemble "keyboard.asm"
                        ; date: 2025-08-12 17:34:05
                        ; --------------------------------------


                        ;+-- Symbols ---
0010:                   PIO_IN_DATA = %00010000 ; Port A data register
0012:                   PIO_IN_CMD = %00010010 ; Port A command register
0011:                   PIO_OUT_DATA = %00010001 ; Port B data register
0013:                   PIO_OUT_CMD = %00010011 ; Port B command register
                        
                        ;Only Port A is hooked up
0000:                   SIO_DATA = %00000000
0002:                   SIO_CMD	= %00000010
                        ;---
                        
                        ;+-- Reset --- 
8000:                           .org $8000
                        
8000:                   reset:
                        				; CPU INITIALISATION
8000: 310050   [10]     				ld sp, $5000
                        
                        				; SIO INITIALISATION
8003: 3E03     [17]     				ld a, %00000011       ; Select WR3
8005: D302     [28]             out (SIO_CMD), a
8007: 3EC1     [35]             ld a, %11000001
                        				;      ││     └─────── Rx Enable
                        				;      └┴───────────── 8 bits per character
8009: D302     [46]             out (SIO_CMD), a
                        
800B: 3E04     [53]             ld a, %00000100       ; Select WR4
800D: D302     [64]             out (SIO_CMD), a
800F: 3E47     [71]             ld a, %01000111
                        				;      │││││││└─────── Parity Enable
                        				;      ││││││└──────── Parity Even
                        				;      ││││└┴───────── 1 Stop Bit
                        				;      ││└┴─────────── Sync Mode Disable
                        				;      └┴───────────── X32 Clock Mode 
8011: D302     [82]             out (SIO_CMD), a
                        
8013: 3E05     [89]     				ld a, %00000101       ; Select WR5
8015: D302     [100]            out (SIO_CMD), a
8017: 3E68     [107]            ld a, %01101000
                        				;       ││ └────────── Tx Enable
                        				;       └┴──────────── 8 bits per character 
8019: D302     [118]            out (SIO_CMD), a 
                        				
                        				; PIO INITIALISATION
801B: 3E0F     [125]    				ld a, %00001111
                        				;      ││││└┴┴┴─────── Identifies Mode Control Word 
                        				;      ││└┴─────────── Don't care 
                        				;      └┴───────────── Mode 0 (Output)
801D: D313     [136]    				out (PIO_OUT_CMD), a	; Write to output port command register
                        
801F: 3E4F     [143]    				ld a, %01001111
                        				;      ││││└┴┴┴─────── Identifies Mode Control Word 
                        				;      ││└┴─────────── Don't care 
                        				;      └┴───────────── Mode 1 (Input)
8021: D312     [154]    				out (PIO_IN_CMD), a		; Write to input port command register
                        ;---
                        
                        ;+-- Loop ---
8023:                   strobe:
8023: 1601     [ 7]     				ld d, %00000001				; Load the initial output coordinate
8025: 0600     [14]     				ld b, 0
                        
8027:                   loop:
8027: 7A       [ 4]     				ld a, d								; Load in the next bit
8028: D311     [15]     				out (PIO_OUT_DATA), a ; Strobe the next bit
                        
802A: DB10     [26]     				in a, (PIO_IN_DATA)		; Read back the input coordinate
802C: C600     [33]     				add 0
802E: CA5C80   [43|43]  				jp z, next
                        
8031: 0EFF     [50]     				ld c, $FF
8033:                   shift1:
8033: 0C       [ 4]     				inc c
8034: CB3F     [12]     				srl a
8036: D23380   [22|22]  				jp nc, shift1 
                        
8039: 210090   [32]     				ld hl, BitsToIndex
803C: 09       [43]     				add hl, bc
803D: 7E       [50]     				ld a, (hl)
                        
803E: 0EFF     [57]     				ld c, $FF
8040: 5A       [61]     				ld e, d
8041:                   shift2:
8041: 0C       [ 4]     				inc c
8042: CB3B     [12]     				srl e
8044: D24180   [22|22]  				jp nc, shift2
                        
8047: 210090   [32]     				ld hl, BitsToIndex
804A: 09       [43]     				add hl, bc
804B: 5E       [50]     				ld e, (hl)
804C: CB23     [58]     				sla e
804E: CB23     [66]     				sla e
8050: CB23     [74]     				sla e
                        	
8052: 83       [78]     				add e									; Add the output coordinate to the input coordinate
                        				
8053: 210890   [88]     				ld hl, CoordsToASCII	; Load the ASCII LUT offset
8056: 4F       [92]     				ld c, a								; Load the index into lower-order byte l
8057: 09       [103]    				add hl, bc						; Load the index into lower-order byte l
8058: 7E       [110]    				ld a, (hl)						; Retrieve ASCII character with index
8059: CD7480   [127]    				call print
                        			
805C:                   next:
805C: CB22     [ 8]     				sla d									; Shit output coordinate left by 1
805E: C22780   [18|18]  				jp nz, loop 					; Break if carry is set (Bit has arrived)
                        
8061: 0602     [25]     				ld b, $02
8063:                   delay1:
8063: C5       [11]     				push bc
8064: 06FF     [18]     				ld b, $FF
8066:                   delay2:
8066: C5       [11]     				push bc
8067: 06FF     [18]     				ld b, $FF
8069:                   delay3:
8069: 10FE     [ 8|13]      		djnz delay3
806B: C1       [18]     				pop bc
806C: 10F8     [26|31]  				djnz delay2
806E: C1       [36]     				pop bc
806F: 10F2     [44|49]  				djnz delay1
                        				
8071: C32380   [54]     				jp strobe 
                        ;---
                        
                        ;+--- Subroutines
                        .local
8074:                   print::
8074: D300     [11]     				out (SIO_DATA), a
8076: 061C     [18]     				ld b, 28     		   		; 7 T
8078:                   delay:												; Total 7 + 13 * 28 = 379 T
8078: 10FE     [ 8|13]      		djnz delay		    		; 28 × 13 + 8 = 372 T
807A: C9       [18]     				ret	
                        .endlocal
                        ;---
                        
                        ;+-- Look-up Tables
                        				.org $9000
9000:                   BitsToIndex:
9000: 00010203          				DB $00, $01, $02, $03, $04, $05, $06, $07
9004: 04050607          
                        
9008:                   CoordsToASCII:
9008: 60380069              		DB 60h, 38h, 00h, 69h, 1Bh, 6Bh, 00h, 2Ch
900C: 1B6B002C          
9010: 3139716F             			DB 31h, 39h, 71h, 6Fh, 61h, 6Ch, 7Ah, 2Eh
9014: 616C7A2E          
9018: 32307770          				DB 32h, 30h, 77h, 70h, 73h, 3Bh, 78h, 2Fh
901C: 733B782F          
9020: 332D655B          				DB 33h, 2Dh, 65h, 5Bh, 64h, 27h, 63h, 00h
9024: 64276300          
9028: 343D725D          				DB 34h, 3Dh, 72h, 5Dh, 66h, 0Ah, 76h, 00h
902C: 660A7600          
9030: 3508745C          				DB 35h, 08h, 74h, 5Ch, 67h, 00h, 62h, 00h
9034: 67006200          
9038: 36007900          				DB 36h, 00h, 79h, 00h, 68h, 00h, 6Eh, 00h
903C: 68006E00          
9040: 37007500          				DB 37h, 00h, 75h, 00h, 6Ah, 20h, 6Dh, 00h
9044: 6A206D00          
                        
9048:                   CoordsToASCIIShift:
9048: 7E2A0049          				DB 7Eh, 2Ah, 00h, 49h, 00h, 4Bh, 00h, 3Ch
904C: 004B003C          
9050: 2128514F          				DB 21h, 28h, 51h, 4Fh, 41h, 4Ch, 5Ah, 3Eh
9054: 414C5A3E          
9058: 40295750          				DB 40h, 29h, 57h, 50h, 53h, 3Ah, 58h, 3Fh
905C: 533A583F          
9060: 235F457B          				DB 23h, 5Fh, 45h, 7Bh, 44h, 22h, 43h, 00h
9064: 44224300          
9068: 242B527D          				DB 24h, 2Bh, 52h, 7Dh, 46h, 00h, 56h, 00h
906C: 46005600          
9070: 2500547C          				DB 25h, 00h, 54h, 7Ch, 47h, 00h, 42h, 00h
9074: 47004200          
9078: 5E005900          				DB 5Eh, 00h, 59h, 00h, 48h, 00h, 4Eh, 00h
907C: 48004E00          
9080: 26005500          				DB 26h, 00h, 55h, 00h, 4Ah, 00h, 4Dh, 00h
9084: 4A004D00          
                        ;---


; +++ segments +++

#CODE          = $8000 = 32768,  size = $1088 =  4232

; +++ global symbols +++

BitsToIndex        = $9000 = 36864          keyboard.asm:137
CoordsToASCII      = $9008 = 36872          keyboard.asm:140
CoordsToASCIIShift = $9048 = 36936          keyboard.asm:150 (unused)
PIO_IN_CMD         = $0012 =    18          keyboard.asm:3
PIO_IN_DATA        = $0010 =    16          keyboard.asm:2
PIO_OUT_CMD        = $0013 =    19          keyboard.asm:5
PIO_OUT_DATA       = $0011 =    17          keyboard.asm:4
SIO_CMD            = $0002 =     2          keyboard.asm:9
SIO_DATA           = $0000 =     0          keyboard.asm:8
_end               = $9088 = 37000          keyboard.asm:13 (unused)
_size              = $1088 =  4232          keyboard.asm:13 (unused)
delay1             = $8063 = 32867          keyboard.asm:108
delay2             = $8066 = 32870          keyboard.asm:111
delay3             = $8069 = 32873          keyboard.asm:114
loop               = $8027 = 32807          keyboard.asm:63
next               = $805C = 32860          keyboard.asm:103
print              = $8074 = 32884          keyboard.asm:126
reset              = $8000 = 32768          keyboard.asm:15 (unused)
shift1             = $8033 = 32819          keyboard.asm:72
shift2             = $8041 = 32833          keyboard.asm:83
strobe             = $8023 = 32803          keyboard.asm:59

; +++ local symbols +++

delay   = $8078 = 32888          keyboard.asm:129


total time: 0.0018 sec.
no errors
