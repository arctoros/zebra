                        ; --------------------------------------
                        ; zasm: assemble "bouncing.asm"
                        ; date: 2025-10-21 21:01:02
                        ; --------------------------------------


                        ;+-- Symbols ---
                        ; IO
0010:                   PIO_IN_DATA = %00010000 ; Port A data register
0012:                   PIO_IN_CMD = %00010010 ; Port A command register
0011:                   PIO_OUT_DATA = %00010001 ; Port B data register
0013:                   PIO_OUT_CMD = %00010011 ; Port B command register
                        
                        ;Only Port B is hooked up
0001:                   SIO_DATA = %00000001
0003:                   SIO_CMD	= %00000011
                        
                        ; RAM
4000:                   KEYBOARD_MAP = $4000
5000:                   STACK = $5000
                        ;---
                        
                        ;+-- Reset --- 
8000:                           .org $8000
                        
8000:                   reset:
                        				; CPU INITIALISATION
8000: 310050   [10]     				ld sp, STACK
                        
                        				; SIO INITIALISATION
8003: 3E03     [17]     				ld a, %00000011       ; Select WR3
8005: D303     [28]             out (SIO_CMD), a
8007: 3EC1     [35]             ld a, %11000001
                        				;      ││     └─────── Rx Enable
                        				;      └┴───────────── 8 bits per character
8009: D303     [46]             out (SIO_CMD), a
                        
800B: 3E04     [53]             ld a, %00000100       ; Select WR4
800D: D303     [64]             out (SIO_CMD), a
800F: 3E47     [71]             ld a, %01000111
                        				;      │││││││└─────── Parity Enable
                        				;      ││││││└──────── Parity Even
                        				;      ││││└┴───────── 1 Stop Bit
                        				;      ││└┴─────────── Sync Mode Disable
                        				;      └┴───────────── X32 Clock Mode 
8011: D303     [82]             out (SIO_CMD), a
                        
8013: 3E05     [89]     				ld a, %00000101       ; Select WR5
8015: D303     [100]            out (SIO_CMD), a
8017: 3E68     [107]            ld a, %01101000
                        				;       ││ └────────── Tx Enable
                        				;       └┴──────────── 8 bits per character 
8019: D303     [118]            out (SIO_CMD), a 
                        
801B: 3E3E     [125]    				ld a, ">"
801D: CD5380   [142]    				call print
                        				
                        				; PIO INITIALISATION
8020: 3E0F     [149]    				ld a, %00001111
                        				;      ││││└┴┴┴─────── Identifies Mode Control Word 
                        				;      ││└┴─────────── Don't care 
                        				;      └┴───────────── Mode 0 (Output)
8022: D313     [160]    				out (PIO_OUT_CMD), a	; Write to output port command register
                        
8024: 3E4F     [167]    				ld a, %01001111
                        				;      ││││└┴┴┴─────── Identifies Mode Control Word 
                        				;      ││└┴─────────── Don't care 
                        				;      └┴───────────── Mode 1 (Input)
8026: D312     [178]    				out (PIO_IN_CMD), a		; Write to input port command register
                        
                        				; Reset Keyboad Map
8028: 0608     [185]    				ld b, 8
802A: 210040   [195]    				ld hl, KEYBOARD_MAP
802D:                   resetKeyboardMap:
802D: 3600     [10]     				ld (hl), 0
802F: 23       [16]     				inc hl
8030: 10FB     [24|29]  				djnz resetKeyboardMap
                        ;---
                        
                        ;+-- Loop ---
8032:                   loop:
8032: 06FF     [ 7]     				ld b, $FF
8034:                   strobe:
8034: C5       [11]     				push bc
8035: 06FF     [18]     				ld b, $FF
8037: 10FE     [ 8|13]  delay: 	djnz delay
                        
8039: 1601     [15]     				ld d, %00000001				; Load the initial output coordinate
803B: 21FF3F   [25]     				ld hl, KEYBOARD_MAP - 1		; Load the initial address of the keyboard map pointer
803E:                   bitBang:
803E: 7A       [ 4]     				ld a, d								; Load in the next bit
803F: D311     [15]     				out (PIO_OUT_DATA), a ; Strobe the next bit
8041: 23       [21]     				inc hl								; Increment keyboard map pointer
8042: CB22     [29]     				sla d									; Shit output coordinate left by 1
8044: DB10     [40]     				in a, (PIO_IN_DATA)		; Read back the input coordinate
8046: 77       [47]     				ld (hl), a						; Load the ready byte into ram at keyboard map pointer
8047: D23E80   [57|57]  				jp nc, bitBang 				; Break if carry is set (Bit has arrived)
                        
804A: C1       [67]     				pop bc
804B: 10E7     [75|80]  				djnz strobe
                        
804D: CD5C80   [92]     				call printCharacters
8050: C33280   [102]    				jp loop
                        ;---
                        
                        ;+--- Subroutines
                        .local
8053:                   print::
8053: C5       [11]     				push bc
8054: D301     [22]     				out (SIO_DATA), a			; Print A to SIO
8056: 061C     [29]     				ld b, 28     		   		; 7 T
8058:                   delay:												; Total 7 + 13 * 28 = 379 T
8058: 10FE     [ 8|13]      		djnz delay		    		; 28 × 13 + 8 = 372 T
805A: C1       [18]     				pop bc
805B: C9       [28]     				ret
                        .endlocal
                        
                        .local
805C:                   printCharacters::
805C: 010000   [10]     				ld bc, 0							; B is data byte, C is bit index
805F: 110000   [20]     				ld de, 0							; D is shift bit, E is unused
8062: 210040   [30]     				ld hl, KEYBOARD_MAP		; hl is map pointer, l is byte index
8065: 7E       [37]     				ld a, (hl)						; Load 0th byte of map
8066: E640     [44]     				and %01000000					; Mask the shift bit
8068: 57       [48]     				ld d, a								; Store shift bit in D
8069:                   byteLoop:
8069: 46       [ 7]     				ld b, (hl)						; Load in next byte of map
                        
806A:                   bitLoop:
806A: CB40     [ 8]     				bit 0, b							; Test the 0th bit
806C: CA8A80   [18|18]  				jp z, next						; Jump if clear
                        															; If bit is set:
806F: C5       [29]     				push bc
8070: E5       [40]     				push hl				
8071: 7D       [44]     				ld a, l								; Load in the byte index
8072: CB27     [52]     				sla a									; Byte Index << 3
8074: CB27     [60]     				sla a
8076: CB27     [68]     				sla a
8078: 81       [72]     				add c									; Add bit index
8079: B2       [76]     				or d									; Set the shift bit accordingly
                        
807A: 210090   [86]     				ld hl, CoordsToASCII	; Load the ASCII LUT offset
807D: 010000   [96]     				ld bc, 0							; Clear BC
8080: 4F       [100]    				ld c, a								; Load character index into c (to prevent 8-bit overflow)
8081: 09       [111]    				add hl, bc						; Add character index
8082: 7E       [118]    				ld a, (hl)						; Retrieve ASCII character with index
8083: C600     [125]    				add 0									; Set the condition flags
8085: C45380   [135|142]				call nz, print				; Only print if not null
                        		
8088: E1       [145]    				pop hl
8089: C1       [155]    				pop bc
                        
808A:                   next:
808A: CB38     [ 8]     				srl b									; Shift byte right
808C: 3E08     [15]     				ld a, 8
808E: 0C       [19]     				inc c									; Increment bit index
808F: B9       [23]     				cp c									; Compare bit index to 8
8090: C26A80   [33|33]  				jp nz, bitLoop				; Repeat if C != 8
                        
8093: 0E00     [40]     				ld c, 0								; If C = 8, reset C
8095: 3E08     [47]     				ld a, lo(KEYBOARD_MAP + 8)	; Load the last address of map
8097: 23       [53]     				inc hl								; Increment byte index
8098: BD       [57]     				cp l									; Compare byte index to last address
8099: C26980   [67|67]  				jp nz, byteLoop				; Repeat if not arrived at last address
809C: C9       [77]     				ret										; Else, return
                        .endlocal
                        ;---
                        
                        ;+-- Look-up Tables
                        				.org $9000
9000:                   CoordsToASCII:
9000: 60380069              		DB 60h, 38h, 00h, 69h, 1Bh, 6Bh, 00h, 2Ch
9004: 1B6B002C          
9008: 3139716F             			DB 31h, 39h, 71h, 6Fh, 61h, 6Ch, 7Ah, 2Eh
900C: 616C7A2E          
9010: 32307770          				DB 32h, 30h, 77h, 70h, 73h, 3Bh, 78h, 2Fh
9014: 733B782F          
9018: 332D655B          				DB 33h, 2Dh, 65h, 5Bh, 64h, 27h, 63h, 00h
901C: 64276300          
9020: 343D725D          				DB 34h, 3Dh, 72h, 5Dh, 66h, 0Ah, 76h, 00h
9024: 660A7600          
9028: 3508745C          				DB 35h, 08h, 74h, 5Ch, 67h, 00h, 62h, 00h
902C: 67006200          
9030: 36007900          				DB 36h, 00h, 79h, 00h, 68h, 00h, 6Eh, 00h
9034: 68006E00          
9038: 37007500          				DB 37h, 00h, 75h, 00h, 6Ah, 20h, 6Dh, 00h
903C: 6A206D00          
                        
9040:                   CoordsToASCIIShift:
9040: 7E2A0049          				DB 7Eh, 2Ah, 00h, 49h, 1Bh, 4Bh, 00h, 3Ch
9044: 1B4B003C          
9048: 2128514F          				DB 21h, 28h, 51h, 4Fh, 41h, 4Ch, 5Ah, 3Eh
904C: 414C5A3E          
9050: 40295750          				DB 40h, 29h, 57h, 50h, 53h, 3Ah, 58h, 3Fh
9054: 533A583F          
9058: 235F457B          				DB 23h, 5Fh, 45h, 7Bh, 44h, 22h, 43h, 00h
905C: 44224300          
9060: 242B527D          				DB 24h, 2Bh, 52h, 7Dh, 46h, 0Ah, 56h, 00h
9064: 460A5600          
9068: 2508547C          				DB 25h, 08h, 54h, 7Ch, 47h, 00h, 42h, 00h
906C: 47004200          
9070: 5E005900          				DB 5Eh, 00h, 59h, 00h, 48h, 00h, 4Eh, 00h
9074: 48004E00          
9078: 26005500          				DB 26h, 00h, 55h, 00h, 4Ah, 20h, 4Dh, 00h
907C: 4A204D00          
                        ;---


; +++ segments +++

#CODE          = $8000 = 32768,  size = $1080 =  4224

; +++ global symbols +++

CoordsToASCII      = $9000 = 36864          bouncing.asm:165
CoordsToASCIIShift = $9040 = 36928          bouncing.asm:175 (unused)
KEYBOARD_MAP       = $4000 = 16384          bouncing.asm:13
PIO_IN_CMD         = $0012 =    18          bouncing.asm:4
PIO_IN_DATA        = $0010 =    16          bouncing.asm:3
PIO_OUT_CMD        = $0013 =    19          bouncing.asm:6
PIO_OUT_DATA       = $0011 =    17          bouncing.asm:5
SIO_CMD            = $0003 =     3          bouncing.asm:10
SIO_DATA           = $0001 =     1          bouncing.asm:9
STACK              = $5000 = 20480          bouncing.asm:14
_end               = $9080 = 36992          bouncing.asm:18 (unused)
_size              = $1080 =  4224          bouncing.asm:18 (unused)
bitBang            = $803E = 32830          bouncing.asm:84
delay              = $8037 = 32823          bouncing.asm:80
loop               = $8032 = 32818          bouncing.asm:75
print              = $8053 = 32851          bouncing.asm:102
printCharacters    = $805C = 32860          bouncing.asm:113
reset              = $8000 = 32768          bouncing.asm:20 (unused)
resetKeyboardMap   = $802D = 32813          bouncing.asm:68
strobe             = $8034 = 32820          bouncing.asm:77

; +++ local symbols +++

delay   = $8058 = 32856          bouncing.asm:106

; +++ local symbols +++

bitLoop  = $806A = 32874          bouncing.asm:123
byteLoop = $8069 = 32873          bouncing.asm:120
next     = $808A = 32906          bouncing.asm:147


total time: 0.0015 sec.
no errors
