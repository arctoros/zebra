                        ; --------------------------------------
                        ; zasm: assemble "timer.asm"
                        ; date: 2025-08-16 21:44:22
                        ; --------------------------------------


                        ;+-- Symbols ---
                        ;Only Port A is hooked up
0000:                   SIO_DATA = %00000000					; Port A data register
0002:                   SIO_CMD	= %00000010						; Port A command register
                        
0010:                   PIO_IN_DATA = %00010000 			; Port A data register
0012:                   PIO_IN_CMD = %00010010 				; Port A command register
0011:                   PIO_OUT_DATA = %00010001 			; Port B data register
0013:                   PIO_OUT_CMD = %00010011 			; Port B command register
                        
0030:                   CTC_C0 = %00110000						; Channel 0
0031:                   CTC_C1 = %00110001						; Channel 1
0032:                   CTC_C2 = %00110010						; Channel 2
0033:                   CTC_C3 = %00110011						; Channel 3
                        
                        ; RAM
5000:                   STACK = $5000
6000:                   KEYBOARD_MAP = $6000					; Low order byte should be $00
5FFF:                   KEYBOARD_TIMER = $5FFF 
                        ;---
                        
                        ;+-- Reset --- 
8000:                           .org $8000
                        
8000:                   reset:
                        				; CPU INITIALISATION
8000: 310050   [10]     				ld sp, STACK
8003: 3E90     [17]     				ld a, hi(intVectors)
8005: ED47     [26]     				ld i, a
8007: ED5E     [34]     				im 2
                        
                        				; SIO INITIALISATION
8009: 3E03     [41]     				ld a, %00000011       ; Select WR3
800B: D302     [52]             out (SIO_CMD), a
800D: 3EC1     [59]             ld a, %11000001
                        				;      ││     └─────── Rx Enable
                        				;      └┴───────────── 8 bits per character
800F: D302     [70]             out (SIO_CMD), a
                        
8011: 3E04     [77]             ld a, %00000100       ; Select WR4
8013: D302     [88]             out (SIO_CMD), a
8015: 3E47     [95]             ld a, %01000111
                        				;      │││││││└─────── Parity Enable
                        				;      ││││││└──────── Parity Even
                        				;      ││││└┴───────── 1 Stop Bit
                        				;      ││└┴─────────── Sync Mode Disable
                        				;      └┴───────────── X32 Clock Mode 
8017: D302     [106]            out (SIO_CMD), a
                        
8019: 3E05     [113]    				ld a, %00000101       ; Select WR5
801B: D302     [124]            out (SIO_CMD), a
801D: 3E68     [131]            ld a, %01101000
                        				;       ││ └────────── Tx Enable
                        				;       └┴──────────── 8 bits per character 
801F: D302     [142]            out (SIO_CMD), a 
                        
                        				; PIO INITIALISATION
8021: 3E0F     [149]    				ld a, %00001111
                        				;      ││││└┴┴┴─────── Identifies Mode Control Word 
                        				;      ││└┴─────────── Don't care 
                        				;      └┴───────────── Mode 0 (Output)
8023: D313     [160]    				out (PIO_OUT_CMD), a	; Write to output port command register
                        
8025: 3E4F     [167]    				ld a, %01001111
                        				;      ││││└┴┴┴─────── Identifies Mode Control Word 
                        				;      ││└┴─────────── Don't care 
                        				;      └┴───────────── Mode 1 (Input)
8027: D312     [178]    				out (PIO_IN_CMD), a		; Write to input port command register
                        
                        				; CTC Initialisation
8029: 3E00     [185]    				ld a, lo(CTCVec)
802B: D330     [196]            out (CTC_C0), a
                                
802D: 3EA5     [203]    				ld a, %10100101
                        				;      │││ │││└─────── Control Word
                        				;      │││ ││└──────── Continued Operation
                        				;      │││ │└───────── Time Constant Follows
                        				;      │││ └────────── Automatic trigger
                        				;      ││└──────────── Prescaler Value = 256 
                        				;      │└───────────── Select Timer Mode
                        				;      └────────────── Enable Interrupts 
802F: D330     [214]            out (CTC_C0), a
                        
8031: 3E1F     [221]    				ld a, $1F							; Start Timer
8033: D330     [232]    				out (CTC_C0), a
                        				
8035: 32FF5F   [245]    				ld (KEYBOARD_TIMER), a ; Init Keyboard Timer to $FF
                        				
                        				; Reset Keyboad Map
8038: 0608     [252]    				ld b, 8
803A: 210060   [262]    				ld hl, KEYBOARD_MAP
803D:                   resetKeyboardMap:
803D: 3600     [10]     				ld (hl), 0
803F: 23       [16]     				inc hl
8040: 10FB     [24|29]  				djnz resetKeyboardMap
                        				
8042: 3E3E     [31]     				ld a, ">"
8044: CD4B80   [48]     				call print
                        				
8047: FB       [52]     				ei
                        ;---
                        
                        ;+-- Loop ---
                        
8048:                   loop:
8048: C34880   [10]     				jp loop 
                        ;---
                        
                        ;+--- Subroutines
                        .local
804B:                   print::
804B: C5       [11]     				push bc
804C: D300     [22]     				out (SIO_DATA), a			; Print A to SIO
804E: 061E     [29]     				ld b, 30
8050: 10FE     [ 8|13]  delay:	djnz delay						; 7 + 13 * 28 + 8 = 379 T
8052: C1       [18]     				pop bc
8053: C9       [28]     				ret
                        .endlocal
                        
                        .local
8054:                   strobe::
8054: F5       [11]     				push af
8055: D5       [22]     				push de
8056: E5       [33]     				push hl
8057: 1601     [40]     				ld d, %00000001				; Load the initial output coordinate
8059: 210060   [50]     				ld hl, KEYBOARD_MAP		; Load the initial address of the keyboard map pointer
805C:                   bitBang:
805C: 7A       [ 4]     				ld a, d								; Load in the next bit
805D: D311     [15]     				out (PIO_OUT_DATA), a ; Strobe the next bit
805F: DB10     [26]     				in a, (PIO_IN_DATA)		; Read back the input coordinate
8061: 77       [33]     				ld (hl), a						; Load the ready byte into ram at keyboard map pointer
8062: 2C       [37]     				inc l									; Increment keyboard map pointer
8063: CB22     [45]     				sla d									; Shit output coordinate left by 1
8065: D25C80   [55|55]  				jp nc, bitBang 				; Break if carry is set (Bit has arrived)
                        
8068: E1       [65]     				pop hl
8069: D1       [75]     				pop de
806A: F1       [85]     				pop af
806B: C9       [95]     				ret
                        .endlocal
                        
                        .local
806C:                   printCharacters::
806C: F5       [11]     				push af
806D: C5       [22]     				push bc
806E: D5       [33]     				push de
806F: E5       [44]     				push hl
                        
8070: 010000   [54]     				ld bc, 0							; B is data byte, C is bit index
8073: 110000   [64]     				ld de, 0							; D is shift bit, E is unused
8076: 210060   [74]     				ld hl, KEYBOARD_MAP		; hl is map pointer, l is byte index
8079: 46       [81]     				ld b, (hl)						; Load 0th byte of map
807A: 78       [85]     				ld a, b
807B: E640     [92]     				and %01000000					; Mask the shift bit
807D: 57       [96]     				ld d, a								; Store shift bit in D
                        
807E:                   loop:
807E: CB40     [ 8]     				bit 0, b							; Test the 0th bit
8080: CA9980   [18|18]  				jp z, next						; Jump if clear
                        															; If bit is set:
8083: C5       [29]     				push bc
8084: E5       [40]     				push hl				
8085: 7D       [44]     				ld a, l								; Load in the byte index
8086: CB27     [52]     				sla a									; Byte Index << 3
8088: CB27     [60]     				sla a
808A: CB27     [68]     				sla a
808C: 81       [72]     				add c									; Add bit index
808D: B2       [76]     				or d									; Set the shift bit accordingly
                        				
808E: 26A0     [83]     				ld h, hi(IndexToASCII); Load the ASCII LUT offset
8090: 6F       [87]     				ld l, a								; Load the index into low-order byte
8091: 7E       [94]     				ld a, (hl)						; Retrieve ASCII character with index
8092: FE00     [101]    				cp 0									; Set the condition flags
8094: C44B80   [111|118]				call nz, print				; Only print if not null
                        		
8097: E1       [121]    				pop hl
8098: C1       [131]    				pop bc
                        
8099:                   next:
8099: CB38     [ 8]     				srl b									; Shift byte right
809B: 3E08     [15]     				ld a, 8
809D: 0C       [19]     				inc c									; Increment bit index
809E: B9       [23]     				cp c									; Compare bit index to 8
809F: C27E80   [33|33]  				jp nz, loop				; Repeat if C != 8
                        
80A2: 0E00     [40]     				ld c, 0								; If C = 8, reset C
80A4: 3E08     [47]     				ld a, lo(KEYBOARD_MAP + 8)	; Load the last address of map
80A6: 23       [53]     				inc hl								; Increment byte index
80A7: 46       [60]     				ld b, (hl)						; Load in next byte of map
80A8: BD       [64]     				cp l									; Compare byte index to last address
80A9: C27E80   [74|74]  				jp nz, loop				; Repeat if not arrived at last address
                        				
80AC: E1       [84]     				pop hl
80AD: D1       [94]     				pop de
80AE: C1       [104]    				pop bc
80AF: F1       [114]    				pop af
80B0: C9       [124]    				ret										; Else, return
                        .endlocal
                        ;---
                        
                        ;+-- Interrupt Handlers
                        				.org $9000
9000:                   intVectors:
9000: 0490              CTCVec:	DB lo(CTCInt), hi(CTCInt)
9002: 1E90              SIOVec:	DB lo(SIOInt), hi(CTCInt)
                        
9004:                   CTCInt:				
9004: CD5480   [17]     				call strobe
                        
9007: 3AFF5F   [30]     				ld a, (KEYBOARD_TIMER)
900A: 3D       [34]     				dec a
900B: 32FF5F   [47]     				ld (KEYBOARD_TIMER), a
900E: E6FF     [54]     				and $FF
9010: CC6C80   [64|71]  				call z, printCharacters
                        
9013: 3EA5     [71]     				ld a, %10100101
9015: D330     [82]             out (CTC_C0), a
9017: 3E1F     [89]     				ld a, $1F							; Start Timer
9019: D330     [100]    				out (CTC_C0), a
                        
901B: FB       [104]    				ei
901C: ED4D     [118]    				reti
                        
901E:                   SIOInt:
901E: FB       [ 4]     				ei
901F: ED4D     [18]     				reti
                        ;---
                        
                        ;+-- Look-up Tables
                        				.org $A000
A000:                   IndexToASCII:
A000: 60380069              		DB 60h, 38h, 00h, 69h, 1Bh, 6Bh, 00h, 2Ch
A004: 1B6B002C          
A008: 3139716F             			DB 31h, 39h, 71h, 6Fh, 61h, 6Ch, 7Ah, 2Eh
A00C: 616C7A2E          
A010: 32307770          				DB 32h, 30h, 77h, 70h, 73h, 3Bh, 78h, 2Fh
A014: 733B782F          
A018: 332D655B          				DB 33h, 2Dh, 65h, 5Bh, 64h, 27h, 63h, 00h
A01C: 64276300          
A020: 343D725D          				DB 34h, 3Dh, 72h, 5Dh, 66h, 0Ah, 76h, 00h
A024: 660A7600          
A028: 3508745C          				DB 35h, 08h, 74h, 5Ch, 67h, 00h, 62h, 00h
A02C: 67006200          
A030: 36007900          				DB 36h, 00h, 79h, 00h, 68h, 00h, 6Eh, 00h
A034: 68006E00          
A038: 37007500          				DB 37h, 00h, 75h, 00h, 6Ah, 20h, 6Dh, 00h
A03C: 6A206D00          
                        
A040: 7E2A0049          				DB 7Eh, 2Ah, 00h, 49h, 1Bh, 4Bh, 00h, 3Ch
A044: 1B4B003C          
A048: 2128514F          				DB 21h, 28h, 51h, 4Fh, 41h, 4Ch, 5Ah, 3Eh
A04C: 414C5A3E          
A050: 40295750          				DB 40h, 29h, 57h, 50h, 53h, 3Ah, 58h, 3Fh
A054: 533A583F          
A058: 235F457B          				DB 23h, 5Fh, 45h, 7Bh, 44h, 22h, 43h, 00h
A05C: 44224300          
A060: 242B527D          				DB 24h, 2Bh, 52h, 7Dh, 46h, 0Ah, 56h, 00h
A064: 460A5600          
A068: 2508547C          				DB 25h, 08h, 54h, 7Ch, 47h, 00h, 42h, 00h
A06C: 47004200          
A070: 5E005900          				DB 5Eh, 00h, 59h, 00h, 48h, 00h, 4Eh, 00h
A074: 48004E00          
A078: 26005500          				DB 26h, 00h, 55h, 00h, 4Ah, 20h, 4Dh, 00h
A07C: 4A204D00          
                        ;---


; +++ segments +++

#CODE          = $8000 = 32768,  size = $2080 =  8320

; +++ global symbols +++

CTCInt           = $9004 = 36868          timer.asm:207
CTCVec           = $9000 = 36864          timer.asm:204
CTC_C0           = $0030 =    48          timer.asm:11
CTC_C1           = $0031 =    49          timer.asm:12 (unused)
CTC_C2           = $0032 =    50          timer.asm:13 (unused)
CTC_C3           = $0033 =    51          timer.asm:14 (unused)
IndexToASCII     = $A000 = 40960          timer.asm:231
KEYBOARD_MAP     = $6000 = 24576          timer.asm:18
KEYBOARD_TIMER   = $5FFF = 24575          timer.asm:19
PIO_IN_CMD       = $0012 =    18          timer.asm:7
PIO_IN_DATA      = $0010 =    16          timer.asm:6
PIO_OUT_CMD      = $0013 =    19          timer.asm:9
PIO_OUT_DATA     = $0011 =    17          timer.asm:8
SIOInt           = $901E = 36894          timer.asm:224
SIOVec           = $9002 = 36866          timer.asm:205 (unused)
SIO_CMD          = $0002 =     2          timer.asm:4
SIO_DATA         = $0000 =     0          timer.asm:3
STACK            = $5000 = 20480          timer.asm:17
_end             = $A080 = 41088          timer.asm:23 (unused)
_size            = $2080 =  8320          timer.asm:23 (unused)
intVectors       = $9000 = 36864          timer.asm:203
loop             = $8048 = 32840          timer.asm:105
print            = $804B = 32843          timer.asm:111
printCharacters  = $806C = 32876          timer.asm:143
reset            = $8000 = 32768          timer.asm:25 (unused)
resetKeyboardMap = $803D = 32829          timer.asm:92
strobe           = $8054 = 32852          timer.asm:121

; +++ local symbols +++

delay   = $8050 = 32848          timer.asm:115

; +++ local symbols +++

bitBang = $805C = 32860          timer.asm:127

; +++ local symbols +++

loop    = $807E = 32894          timer.asm:157
next    = $8099 = 32921          timer.asm:179


total time: 0.0017 sec.
no errors
